import os
from pathlib import Path
import shutil
from mutagen.easyid3 import EasyID3
from mutagen.flac import FLAC
from mutagen.mp3 import MP3


test_data_path = Path(__file__).resolve().parent / "libraries"

# fmt: off
empty_flac_file_data = bytearray([
    0x66,0x4c,0x61,0x43,0x00,0x00,0x00,0x22,0x10,0x00,0x10,0x00,0xff,0xff,0xff,0x00,  # |fLaC..."........|
    0x00,0x00,0x0a,0xc4,0x42,0xf0,0x00,0x00,0x00,0x00,0xd4,0x1d,0x8c,0xd9,0x8f,0x00,  # |....B...........|
    0xb2,0x04,0xe9,0x80,0x09,0x98,0xec,0xf8,0x42,0x7e,0x84,0x00,0x00,0x28,0x20,0x00,  # |........B~...( .|
    0x00,0x00,0x72,0x65,0x66,0x65,0x72,0x65,0x6e,0x63,0x65,0x20,0x6c,0x69,0x62,0x46,  # |..reference libF|
    0x4c,0x41,0x43,0x20,0x31,0x2e,0x33,0x2e,0x33,0x20,0x32,0x30,0x31,0x39,0x30,0x38,  # |LAC 1.3.3 201908|
    0x30,0x34,0x00,0x00,0x00,0x00                                                     # |04....|
])

empty_mp3_file_data = bytearray([
    0x49,0x44,0x33,0x04,0x00,0x00,0x00,0x00,0x00,0x23,0x54,0x53,0x53,0x45,0x00,0x00,  # |ID3......#TSSE..|
    0x00,0x0f,0x00,0x00,0x03,0x4c,0x61,0x76,0x66,0x35,0x38,0x2e,0x37,0x36,0x2e,0x31,  # |.....Lavf58.76.1|
    0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xfb,0x40,  # |00.............@|
    0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  # |................|
    0x00,0x00,0x49,0x6e,0x66,0x6f,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x02,0x00,0x00,  # |..Info..........|
    0x01,0x86,0x00,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,  # |................|
    0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,  # |................|
    0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,0xbb,  # |................|
    0xbb,0xbb,0xbb,0xbb,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,  # |................|
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,  # |................|
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,  # |................|
    0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x4c,0x61,0x76,0x63,0x35,0x38,  # |..........Lavc58|
    0x2e,0x31,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24,  # |.13............$|
    0x06,0x68,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x86,0x62,0x56,0x43,0xc1,0x00,0x00,  # |.h........bVC...|
    0x00,0x00,0x00,0xff,0xfb,0x10,0xc4,0x00,0x03,0xc0,0x00,0x01,0xa4,0x00,0x00,0x00,  # |................|
    0x20,0x00,0x00,0x34,0x80,0x00,0x00,0x04,0x4c,0x41,0x4d,0x45,0x33,0x2e,0x31,0x30,  # | ..4....LAME3.10|
    0x30,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |0UUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0xff,0xfb,0x10,0xc4,0x29,  # |UUUUUUUUUUU....)|
    0x83,0xc0,0x00,0x01,0xa4,0x00,0x00,0x00,0x20,0x00,0x00,0x34,0x80,0x00,0x00,0x04,  # |........ ..4....|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,  # |UUUUUUUUUUUUUUUU|
    0x55,0x55,0x55                                                                    # |UUU|
])
# fmt: on


def create_file(path: Path, spec: dict):
    os.makedirs(path, exist_ok=True)
    filename: Path = path / spec["source_file"]
    with open(filename, "wb") as file:
        if filename.suffix == ".flac":
            file.write(empty_flac_file_data)
        elif filename.suffix == ".mp3":
            file.write(empty_mp3_file_data)
    mut = None
    if filename.suffix == ".flac":
        mut = FLAC(filename)
    elif filename.suffix == ".mp3":
        mut = MP3(filename, ID3=EasyID3)

    if mut is not None:
        for name, value in spec.get("tags", {}).items():
            mut[name] = value
        # minimum padding ensures small changes to tags will change file size for test
        mut.save(padding=lambda info: 0)


def create_album_in_library(library_path: Path, album: dict):
    for track in album["tracks"]:
        create_file(library_path / album["path"], track)


def create_library(library_name: str, albums: list[dict]):
    library_path = test_data_path / library_name
    shutil.rmtree(library_path, ignore_errors=True)
    for album in albums:
        create_album_in_library(library_path, album)
    return library_path
