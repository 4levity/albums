import os
from pathlib import Path
from mutagen.flac import FLAC


test_data_path = Path(__file__).resolve().parent / "libraries"

# fmt: off
empty_flac_file_data = bytearray([
    0x66,0x4c,0x61,0x43,0x00,0x00,0x00,0x22,0x10,0x00,0x10,0x00,0xff,0xff,0xff,0x00,  # |fLaC..."........|
    0x00,0x00,0x0a,0xc4,0x42,0xf0,0x00,0x00,0x00,0x00,0xd4,0x1d,0x8c,0xd9,0x8f,0x00,  # |....B...........|
    0xb2,0x04,0xe9,0x80,0x09,0x98,0xec,0xf8,0x42,0x7e,0x84,0x00,0x00,0x28,0x20,0x00,  # |........B~...( .|
    0x00,0x00,0x72,0x65,0x66,0x65,0x72,0x65,0x6e,0x63,0x65,0x20,0x6c,0x69,0x62,0x46,  # |..reference libF|
    0x4c,0x41,0x43,0x20,0x31,0x2e,0x33,0x2e,0x33,0x20,0x32,0x30,0x31,0x39,0x30,0x38,  # |LAC 1.3.3 201908|
    0x30,0x34,0x00,0x00,0x00,0x00                                                     # |04....|
])
# fmt: on


def create_file(path: Path, spec: dict):
    os.makedirs(path, exist_ok=True)
    filename = path / spec["source_file"]
    with open(filename, "wb") as file:
        file.write(empty_flac_file_data)
    mut = FLAC(filename)
    # TODO add tags
    mut.save(padding=lambda info: 0)


def create_library(library_name: str, albums: list[dict]):
    library_path = test_data_path / library_name
    for album in albums:
        for track in album["tracks"]:
            create_file(library_path / album["path"], track)
    return library_path
